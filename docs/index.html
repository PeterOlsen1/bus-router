<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peter's Bus Router</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <style>
    </style>
    <link rel="stylesheet" href="./css/index.css">
</head>
<body>
    <div class="flex-center title">
        Metro Transit Bus Tracker
    </div>

    <div class="flex-center">
        <div style="margin-top: 50px; font-size: 20pt">
            Where are you going?
        </div>
        
        <div>
            <button class="pure-button" onclick="showData('to')">
                To Campus
            </button>
            <button class="pure-button" onclick="showData('from')">
                Off Campus
            </button>
        </div>
        <div style="margin-top: -20px;">
            <button class="pure-button" onclick="configure()">
                Configure
            </button>
        </div>

        <div class="pure-form pure-form-stacked">
            <fieldset class="flex-center">
                <div class="pure-control-group inline-flex-center" style="width: 450px;">
                    <label for="route">Select Route</label>
                    <select name="route" id="route"></select>
                </div>

                <div class="pure-control-group inline-flex-center" style="width: 300px;">
                    <label for="stop-id">Stop ID</label>
                    <input name="stop-id" id="stop-id" maxlength="8" style='width: 100px;'>
                    <br>
                    <span style="font-size: 10pt; margin-top: -20px;">Not sure which stop ID you're looking for? Check out it out on <a id="map-link" target="_blank">this map.</a></span>
                </div>
            </fieldset>
        </div>

        <div class="flex-center" style='gap: 0px' id="bus-info"></div>
    </div>
</body>
<script>
    /**
    * Essentially just document.querySelector with a shorter name
    */
    function $(query) {
        return document.querySelector(query);
    }

    async function configure() {
        //select proper items
        $('#bus-info').style.display = 'none';
        const select = $('select');

        //get routes
        const routes = await getMetroTransit('/routes');

        //add to select box
        for (let route of routes) {
            const option = document.createElement('option');
            option.innerHTML = `${route.route_id} - ${route.route_label}`;
            //option.id = 'route-' + route.route_id;
            option.value = route.route_id;
            select.appendChild(option);
        }

        select.addEventListener('input', (event) => {
            $('#map-link').href = 'https://www.metrotransit.org/Route/' + select.value;
        });

    }


    async function getMetroTransit(query) {
        const url = 'https://svc.metrotransit.org/nextrip' + query;
        console.log(url);
    
        try {
            let resp = await fetch(url);
            let data = await resp.json();
            return data;
        }
        catch (error) {
            throw error;
        }
    }
    
    async function showData(dir) {
        let data;
        const container = $('#bus-info');
    
        if (dir == 'to') {
            data = await getMetroTransit('/16102');
        }
        else {
            data = await getMetroTransit('/80666');
        }
    
        // <div class="card">
        //     <div class="card-top">
        //         Bus in 30
        //     </div>
        //     Departing from rollins longer text longer text
        // </div>  
        let out = '';
        for (let dep of data.departures) {
            if (dep.route_id != 3) {
                continue;
            }
            const dep_text = dep.departure_text;
    
            out += `
            <div class="card">
                <div class="card-top">
                    ${dep_text.includes(':') ? 
                    "Bus at " + dep_text :
                    "Bus in " + dep_text
                }
                </div>
                ${
                    `Bus ${dep.route_id}${dep.terminal} - ${dep.description}`
                }
            </div>   
            `
        }
    
        container.innerHTML = out;
    }   
</script>
</html>